name: Sign iOS IPA

on:
  workflow_dispatch:

jobs:
  sign-ipa:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install gdown using pipx
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install pipx
          pipx install gdown

      - name: Download IPA
        run: |
          gdown "https://drive.google.com/uc?id=1IllWdFD2eHowTVDelG3hpbhme9Tlzhy2" -O MLBB_unsigned.ipa

      - name: Inspect and unzip IPA
        run: |
          unzip -q MLBB_unsigned.ipa
          echo "üì¶ Contents of Payload:"
          ls -l Payload
          echo "üìÇ Contents of .app:"
          ls -l Payload/*.app

      - name: Show binary info
        run: |
          file Payload/*.app/*
          otool -hv Payload/*.app/* || true
          codesign --display --verbose=4 Payload/*.app/* || true

      - name: Attempt re-sign
        run: |
          echo "üîè Attempting to re-sign..."
          codesign -s - --force --deep --options=runtime Payload/*.app || {
            echo "‚ùå Code signing failed"
            exit 1
          }

          zip -qry MLBB_signed.ipa Payload
          echo "‚úÖ Re-sign completed"

      - name: Upload signed IPA
        uses: actions/upload-artifact@v4
        with:
          name: MLBB_signed
          path: MLBB_signed.ipa
